[데모보드: stm32h750vbt6 ](https://uraetech.co.kr/product/stm32-stm32h750vbt6-evaluation-board-stm32cubeide/2816/category/1/display/52/)

아래는 "문서 파일만 저장 가능한 특별한 USB 스틱"을 구현하고자 할 때 필요한 **하드웨어 구성, 펌웨어/소프트웨어 구현, 파일 필터링 방식, OS 통합 방법** 등을 **윈도우 중심으로 자세히 설명**한 것입니다.
```
윈도우 PC의 usb 포트에 sd card가 포함된 usb스틱을 끼우면,
F: 등의 드라이버가 탐색창에 뜨고 파일을 복사할 수 있도록 하드웨어를 만들고,
소프트웨어도 작성하고 싶어,
이 특별한 장치는 모든 파일을 저장할 수 없고,
오직 문서 파일만 저장이 가능하도록 하고 싶어,
추가적이 소프트웨어 설치 없이 usb 만 끼우면 작동이 되도록 하고 싶은데,
어떻게 해야 할지 자세히 알려줘.
```
---

## ✅ 목표 요약

> **특수 USB 스토리지 장치**

* SD 카드 기반 저장소 사용 (USB로 연결됨)
* **Windows 탐색기에서 자동 인식됨** (예: F:)
* **추가 소프트웨어 설치 없이 작동** (Plug & Play)
* **문서 파일만 저장 가능** (`.doc`, `.pdf`, `.txt` 등)
* 그 외 파일은 **쓰기 차단**

---

## 🧩 구성 요소 개요

| 구분            | 설명                                                                  |
| ------------- | ------------------------------------------------------------------- |
| **하드웨어**      | USB to SD 카드 리더 + 커스텀 펌웨어 마이크로컨트롤러                                  |
| **파일 시스템 제어** | 펌웨어에서 FAT32 제어 또는 가상 Mass Storage 구현                                |
| **OS 통합**     | Windows에서 표준 Mass Storage로 인식됨                                      |
| **필터링 방식**    | ① 펌웨어 레벨에서 파일 확장자 검사 후 쓰기 거부<br>② 또는 Windows용 필터 드라이버 (단, 추가 설치 필요) |
| **문서 인식 방식**  | 확장자 기반 + 파일 서명 검사(Optional)                                         |

---

## 🔧 1. 하드웨어 구성

### ✔️ 기본 구성

* **MCU (마이크로컨트롤러)**: STM32, ESP32, RP2040 중 하나
* **SD 카드 인터페이스**: SPI 또는 SDIO
* **USB 인터페이스**: USB Device 기능 포함 MCU
* **동작 방식**: MCU가 SD카드를 USB Mass Storage Class 장치로 에뮬레이션

> 📌 MCU가 USB Mass Storage Class 장치로 동작해야 함. 예: STM32 + USB CDC MSC 라이브러리 사용

### ✔️ 추천 구성 예

* **STM32F4xx + USB MSC + FATFS**
* **RP2040 + TinyUSB + LittleFS**
* **MicroSD 슬롯 + USB A 단자 일체형 보드 설계**

---

## 🧠 2. 펌웨어 구현 – 문서 파일 필터링

### 옵션 1: **쓰기 요청 검사 방식 (펌웨어 레벨)**

1. USB Mass Storage 인터페이스로 동작
2. **쓰기 요청 발생 시**, FAT 파일명, 확장자 검사
3. `.doc`, `.docx`, `.pdf`, `.txt`, `.md`, `.rtf`만 허용
4. 허용되지 않은 확장자의 쓰기 요청은 **무시 또는 에러 응답**

> ❗ FAT32와 같은 파일 시스템 직접 핸들링 필요 (파일명, LFN 구조 이해 필요)

---

## 💻 3. 소프트웨어 구성 (추가 설치 없는 방식)

### ✔️ 조건: **Windows에 드라이버 추가 설치 없이 자동 동작**

* **필수**: USB Mass Storage Class 지원 (기본 지원됨)
* **불가**: 커널 필터 드라이버 방식은 별도 설치 필요

### 가능 방식

1. **USB 펌웨어에서 자체적으로 저장 제한 구현**

   * 외부 프로그램/드라이버 불필요
   * 사용자는 USB를 꽂으면 일반 저장장치처럼 보이나, 비문서 파일 저장 시 실패

---

## ✏️ 예시: 허용 파일 확장자 제한 목록

```c
bool is_allowed(const char* filename) {
    const char* ext = strrchr(filename, '.');
    if (!ext) return false;
    return (
        strcmp(ext, ".txt") == 0 ||
        strcmp(ext, ".pdf") == 0 ||
        strcmp(ext, ".doc") == 0 ||
        strcmp(ext, ".docx") == 0 ||
        strcmp(ext, ".rtf") == 0
    );
}
```

* FAT 파일 이름 구조 분석 필요 (8.3, LFN 등)
* TinyUSB/STM32 USB MSC 예제 기반으로 확장 가능

---

## 💡 추가 아이디어 (고급)

| 기능            | 설명                                       |
| ------------- | ---------------------------------------- |
| **읽기는 모두 허용** | 모든 파일 읽기는 가능하게 유지                        |
| **쓰기 실패 메시지** | "쓰기 불가: 허용되지 않은 파일 유형" HTML/TXT 파일 자동 생성 |
| **파일 내용 검사**  | 확장자 속이고 실제 바이너리 검사 가능 (Magic Number 활용)  |
| **암호화 저장**    | 내부에서만 복호화 가능한 구조도 가능                     |

---

## ✅ 요약 체크리스트

| 항목                                 | 여부              |
| ---------------------------------- | --------------- |
| USB로 연결되면 드라이브 자동 생성 (Plug & Play) | ✅               |
| SD카드 기반 파일 저장 기능                   | ✅               |
| 추가 소프트웨어 없이 작동                     | ✅               |
| 문서 파일만 저장 가능                       | ✅ (펌웨어 레벨 구현 시) |
| 다른 파일은 저장 불가                       | ✅ (쓰기 요청 거부)    |

---

## 🔚 마무리

이 방식은 **하드웨어 설계와 펌웨어 커스터마이징이 핵심**입니다. Windows OS에 의존하지 않고 USB 장치가 자체적으로 파일 제어를 수행하므로, 목적에 가장 부합하는 방법입니다.

필요 시 아래도 도와드릴 수 있습니다:

* TinyUSB 기반 펌웨어 예제 제공
* STM32Cube 프로젝트 샘플
* PCB 설계(USB + SD Slot)

언제든지 더 알려주세요!


네, **STM32Cube + USB + SD 카드 + MSC(Mass Storage Class)** 조합으로 “문서 파일만 저장 가능하게” 제한하는 기능은 가능합니다. 다만 **일반적인 MSC는 USB 저장 장치를 ‘전체 볼륨’으로 PC에 노출**하기 때문에, OS 단에서 어떤 파일이든 복사할 수 있습니다. 그래서 "문서 파일만 저장 가능하게" 만들기 위해서는 몇 가지 **특별한 설계**가 필요합니다:

---

## ✅ 가능한 접근 방식

### 1. **MSC 대신 MTP 또는 커스텀 클래스 사용 (권장)**

* \*\*MTP(Media Transfer Protocol)\*\*는 MSC처럼 저장 장치를 전체 드라이브로 마운트하지 않고, **파일 단위**로 접근합니다.
* 이를 STM32에서 구현하면, **호스트(PC)에서 파일을 복사하려고 할 때**, STM32 펌웨어에서 파일 이름을 검사하여 `.txt`, `.pdf`, `.docx` 등만 허용 가능.
* 단점: STM32에서 MTP 구현은 복잡하며, USB 스택 커스터마이징이 필요.

### 2. **MSC를 사용하지만 SD 카드 파일시스템을 감시하는 방식**

* MSC로 마운트는 허용하되, **STM32가 주기적으로 SD 카드의 파일 시스템을 스캔하여 비허용 파일을 즉시 삭제**하거나 무효화.
* 예: FATFS를 통해 SD를 모니터링하며 `.mp4`, `.exe` 등은 자동 삭제.
* 단점: 삭제 타이밍 이슈가 있고, 실시간 대응이 어려움.

### 3. **파일 시스템 계층에서 Write Filter 구현**

* MSC를 통해 들어오는 쓰기 요청을 가로채서, `.txt`, `.pdf`, `.docx`, `.rtf` 외의 확장자는 거부하는 **파일시스템 후킹**을 구현.
* STM32Cube USB Device Library의 `USBD_MSC_BOT.c` 또는 `usbd_storage_if.c`의 `STORAGE_Write()`에서 검사 가능.

```c
int8_t STORAGE_Write(...) {
    if (!is_allowed(filename)) {
        return USBD_FAIL;
    }
    ...
}
```

> 단점: MSC에서는 실제로 "파일명"이 아니라 **블록 주소**가 전달되기 때문에, 파일명을 알 수 없습니다. → **실제 파일 필터링은 불가능**.

---

## 🚫 결론: MSC 단독으로는 **파일 확장자 필터링이 불가능**

* MSC는 파일명이 아닌 **블록 단위 접근** 방식입니다. 즉, **PC가 어떤 파일을 쓰고 있는지 STM32는 모릅니다.**
* 따라서 "문서 파일만 저장" 제한은 **MSC 구조에서는 불가능**합니다.

---

## ✅ 현실적인 해결책 요약

| 방법               | 설명                     | 가능 여부      |
| ---------------- | ---------------------- | ---------- |
| **MSC + 필터링**    | 파일명 알 수 없어 불가능         | ❌          |
| **MTP 프로토콜 사용**  | 파일 이름 기반 필터링 가능        | ✅ (복잡함)    |
| **가상 파일 시스템 구성** | STM32 내부에 파일 시스템 시뮬레이션 | ✅ (복잡함)    |
| **외부 삭제기 실행**    | STM32가 정기적으로 검사 및 삭제   | ⚠️ (우회 가능) |

---

## 🔧 제안

* 보안 목적이라면 **MSC 대신 MTP** 또는 **HID 기반 커스텀 프로토콜**로 구현하는 것이 적절합니다.
* STM32H7이나 STM32F7 계열처럼 성능이 되는 칩에서는 **MTP 구현**을 도전해볼 수 있습니다.

---

필요하시면 STM32에서 **MTP 구현 예제**나, **커스텀 USB 클래스 설계** 방식도 안내드릴 수 있습니다.
